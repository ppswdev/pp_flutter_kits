# 订阅状态监听使用指南

## 功能概述

StoreKit2Manager 提供了完整的订阅状态监听功能，可以实时检测订阅状态变化，包括：
- ✅ 订阅状态变化（已订阅 → 已过期 → 已撤销等）
- ✅ 订阅取消（`willAutoRenew` 从 `true` 变为 `false`）
- ✅ 进入宽限期（`RenewalState.inGracePeriod`）
- ✅ 进入计费重试期（`RenewalState.inBillingRetryPeriod`）
- ✅ 订阅过期（`RenewalState.expired`）
- ✅ 订阅撤销（`RenewalState.revoked`）

## 工作原理

### 自动监听

StoreKit2Manager 在启动时会自动开始订阅状态监听：
- **定期检查**：每30秒自动检查一次所有已购买的订阅状态
- **状态缓存**：缓存上次的订阅状态，只有变化时才通知
- **并行处理**：使用 `TaskGroup` 并行检查多个订阅，提高效率

### 手动检查

除了自动监听，还可以在关键时机手动检查：
- 应用启动时
- 应用进入前台时
- 用户打开订阅页面时
- 购买/恢复购买后

## 使用方法

### 1. 监听状态变化（通过 Delegate）

```swift
import StoreKit2Manager

class MyViewController: UIViewController, StoreKitDelegate {
    
    override func viewDidLoad() {
        super.viewDidLoad()
        
        // 设置代理
        StoreKit2Manager.shared.delegate = self
    }
    
    // MARK: - StoreKitDelegate
    
    func storeKit(_ manager: StoreKit2Manager, didUpdateState state: StoreKitState) {
        switch state {
        case .subscriptionStatusChanged(let status):
            handleSubscriptionStatusChange(status)
            
        case .subscriptionCancelled(let productId):
            handleSubscriptionCancelled(productId)
            
        default:
            break
        }
    }
    
    private func handleSubscriptionStatusChange(_ status: RenewalState) {
        switch status {
        case .subscribed:
            print("订阅已激活")
            // 更新UI，解锁功能
            
        case .expired:
            print("订阅已过期")
            // 更新UI，禁用功能
            // 提示用户重新订阅
            
        case .inGracePeriod:
            print("订阅在宽限期内")
            // 提示用户更新支付方式
            // 功能仍然可用
            
        case .inBillingRetryPeriod:
            print("订阅在计费重试期")
            // 提示用户更新支付方式
            // 功能仍然可用
            
        case .revoked:
            print("订阅已撤销")
            // 更新UI，禁用功能
            
        @unknown default:
            break
        }
    }
    
    private func handleSubscriptionCancelled(_ productId: String) {
        print("订阅已取消: \(productId)")
        
        // 获取续订信息，显示过期时间
        Task {
            if let renewalInfo = await StoreKit2Manager.shared.getRenewalInfo(for: productId) {
                if let expirationDate = renewalInfo.expirationDate {
                    let formatter = DateFormatter()
                    formatter.dateFormat = "yyyy年MM月dd日"
                    print("订阅将在 \(formatter.string(from: expirationDate)) 过期")
                    
                    // 显示提示："订阅已取消，将在 X 天后失效"
                    let daysRemaining = Calendar.current.dateComponents([.day], 
                        from: Date(), 
                        to: expirationDate).day ?? 0
                    if daysRemaining > 0 {
                        showAlert("订阅已取消", "您的订阅将在 \(daysRemaining) 天后失效")
                    }
                }
            }
        }
    }
}
```

### 2. 监听状态变化（通过闭包）

```swift
import StoreKit2Manager

class MyViewController: UIViewController {
    
    override func viewDidLoad() {
        super.viewDidLoad()
        
        // 设置状态变化回调
        StoreKit2Manager.shared.onStateChanged = { [weak self] state in
            switch state {
            case .subscriptionStatusChanged(let status):
                self?.handleSubscriptionStatusChange(status)
                
            case .subscriptionCancelled(let productId):
                self?.handleSubscriptionCancelled(productId)
                
            default:
                break
            }
        }
    }
    
    private func handleSubscriptionStatusChange(_ status: RenewalState) {
        // 处理状态变化
    }
    
    private func handleSubscriptionCancelled(_ productId: String) {
        // 处理订阅取消
    }
}
```

### 3. 在关键时机手动检查

#### 应用启动时

```swift
// 在 AppDelegate 中
func application(_ application: UIApplication, 
                didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
    
    // 启动 StoreKit2Manager
    // ...
    
    // 检查订阅状态
    Task {
        await StoreKit2Manager.shared.checkSubscriptionStatus()
    }
    
    return true
}
```

#### 应用进入前台时

```swift
// 在 AppDelegate 中
func applicationDidBecomeActive(_ application: UIApplication) {
    Task {
        await StoreKit2Manager.shared.checkSubscriptionStatus()
    }
}

// 或在 SceneDelegate 中
func sceneWillEnterForeground(_ scene: UIScene) {
    Task {
        await StoreKit2Manager.shared.checkSubscriptionStatus()
    }
}
```

#### 订阅页面显示前

```swift
class SubscriptionViewController: UIViewController {
    
    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        
        // 检查订阅状态
        Task {
            await StoreKit2Manager.shared.checkSubscriptionStatus()
        }
    }
}
```

#### 购买/恢复购买后

```swift
func purchaseSuccess() {
    Task {
        // 刷新购买列表
        await StoreKit2Manager.shared.refreshPurchases()
        
        // 检查订阅状态
        await StoreKit2Manager.shared.checkSubscriptionStatus()
    }
}
```

## 状态说明

### RenewalState 枚举值

| 状态 | 说明 | 处理建议 |
|------|------|----------|
| `.subscribed` | 订阅已激活 | 正常使用，解锁功能 |
| `.expired` | 订阅已过期 | 禁用功能，提示重新订阅 |
| `.inGracePeriod` | 在宽限期内 | 功能可用，提示更新支付方式 |
| `.inBillingRetryPeriod` | 在计费重试期 | 功能可用，提示更新支付方式 |
| `.revoked` | 已撤销 | 禁用功能，可能是退款导致 |

### 订阅取消检测

当 `willAutoRenew` 从 `true` 变为 `false` 时，会触发 `.subscriptionCancelled` 状态：
- 订阅仍然有效，直到 `expirationDate`
- 需要检查 `RenewalInfo.expirationDate` 获取过期时间
- 可以显示"订阅已取消，将在 X 天后失效"的提示

## 完整示例

```swift
import UIKit
import StoreKit2Manager

class SubscriptionManager: NSObject, StoreKitDelegate {
    
    static let shared = SubscriptionManager()
    
    override init() {
        super.init()
        setupStoreKit()
    }
    
    private func setupStoreKit() {
        // 设置代理
        StoreKit2Manager.shared.delegate = self
        
        // 配置 StoreKit2Manager
        // ...
    }
    
    // MARK: - StoreKitDelegate
    
    func storeKit(_ manager: StoreKit2Manager, didUpdateState state: StoreKitState) {
        switch state {
        case .subscriptionStatusChanged(let status):
            handleSubscriptionStatusChange(status)
            
        case .subscriptionCancelled(let productId):
            handleSubscriptionCancelled(productId)
            
        default:
            break
        }
    }
    
    private func handleSubscriptionStatusChange(_ status: RenewalState) {
        switch status {
        case .subscribed:
            enablePremiumFeatures()
            
        case .expired:
            disablePremiumFeatures()
            showSubscriptionExpiredAlert()
            
        case .inGracePeriod:
            showGracePeriodAlert()
            
        case .inBillingRetryPeriod:
            showBillingRetryAlert()
            
        case .revoked:
            disablePremiumFeatures()
            showSubscriptionRevokedAlert()
            
        @unknown default:
            break
        }
    }
    
    private func handleSubscriptionCancelled(_ productId: String) {
        Task {
            if let renewalInfo = await StoreKit2Manager.shared.getRenewalInfo(for: productId),
               let expirationDate = renewalInfo.expirationDate {
                let daysRemaining = Calendar.current.dateComponents([.day], 
                    from: Date(), 
                    to: expirationDate).day ?? 0
                
                if daysRemaining > 0 {
                    showAlert(
                        title: "订阅已取消",
                        message: "您的订阅将在 \(daysRemaining) 天后失效。在此之前，您仍可继续使用所有功能。"
                    )
                }
            }
        }
    }
    
    private func enablePremiumFeatures() {
        // 解锁高级功能
    }
    
    private func disablePremiumFeatures() {
        // 禁用高级功能
    }
    
    private func showSubscriptionExpiredAlert() {
        // 显示订阅过期提示
    }
    
    private func showGracePeriodAlert() {
        // 显示宽限期提示
    }
    
    private func showBillingRetryAlert() {
        // 显示计费重试提示
    }
    
    private func showSubscriptionRevokedAlert() {
        // 显示订阅撤销提示
    }
}
```

## 注意事项

1. **检查频率**：默认30秒检查一次，可以根据需要调整 `subscriptionCheckInterval`
2. **资源消耗**：定期检查会消耗少量资源，但影响很小
3. **网络依赖**：需要网络连接才能检查状态
4. **状态延迟**：状态变化可能有几秒到几分钟的延迟
5. **缓存机制**：只有状态变化时才会通知，避免重复通知

## 与 Transaction.updates 的区别

| 功能 | Transaction.updates | 订阅状态监听 |
|------|---------------------|--------------|
| 新购买 | ✅ | ❌ |
| 订阅续订 | ✅ | ❌ |
| 退款 | ✅ | ❌ |
| 订阅状态变化 | ❌ | ✅ |
| 订阅取消 | ❌ | ✅ |
| 订阅过期 | ❌ | ✅ |
| 宽限期 | ❌ | ✅ |

**建议**：同时使用两种监听方式，确保完整覆盖所有场景。

---

**订阅状态监听功能已完整实现！** 🎉

