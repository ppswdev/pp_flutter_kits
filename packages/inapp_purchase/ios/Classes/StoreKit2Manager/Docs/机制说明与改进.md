# StoreKit 2 机制说明与改进

## 1. Transaction.updates 机制详解

### 工作原理

`Transaction.updates` 是一个 `AsyncSequence`，用于实时监听交易更新。它的工作机制如下：

#### ✅ 会自动触发的情况：

1. **新购买**：用户购买产品时
2. **订阅续订**：自动续订订阅成功续订时
3. **退款**：用户申请退款，Apple 批准后
4. **撤销**：订阅被撤销（如家庭共享被移除）
5. **升级/降级**：订阅升级或降级时
6. **优惠代码兑换**：用户兑换优惠代码时
7. **恢复购买**：通过 `AppStore.sync()` 恢复的购买

#### ❌ 不会自动触发的情况：

1. **订阅过期**：订阅自然过期不会触发 `Transaction.updates`
   - 原因：过期是时间到达，不是新交易
   - 解决方案：需要定期检查 `Product.SubscriptionInfo.status`

2. **用户取消订阅**：在设置中取消订阅不会立即触发
   - 原因：取消只是标记不续订，当前订阅仍然有效直到过期
   - 解决方案：需要监听订阅状态变化

3. **订阅进入宽限期/计费重试期**：不会触发新交易
   - 原因：这些是状态变化，不是新交易
   - 解决方案：需要定期检查订阅状态

### Transaction.updates 的使用场景

```swift
// ✅ 适合使用 Transaction.updates 的场景：
// 1. 监听新购买
// 2. 监听订阅续订
// 3. 监听退款/撤销
// 4. 监听优惠代码兑换
// 5. 监听恢复购买

// ❌ 不适合使用 Transaction.updates 的场景：
// 1. 检查订阅是否过期（需要定期检查状态）
// 2. 检查订阅是否被取消（需要检查 RenewalInfo.willAutoRenew）
// 3. 检查订阅进入宽限期（需要检查 RenewalState）
```

### 订阅状态监听的正确方式

```swift
// 方式1：定期检查订阅状态（推荐）
Task {
    while !Task.isCancelled {
        await checkSubscriptionStatus()
        try? await Task.sleep(nanoseconds: 60_000_000_000) // 每分钟检查一次
    }
}

// 方式2：在关键时机检查
// - 应用启动时
// - 应用进入前台时
// - 用户打开订阅相关页面时
```

---

## 2. AppTransaction 的作用

### 什么是 AppTransaction？

`AppTransaction` 表示应用本身的交易信息，不是产品购买交易。

### 主要用途：

1. **获取应用购买信息**：
   - 应用首次购买日期
   - 应用版本信息
   - 应用购买平台

2. **防欺诈检测**：
   - 设备验证数据
   - 应用交易ID

3. **应用生命周期管理**：
   - 判断应用是否为新用户
   - 判断应用是否从其他平台迁移

### 使用场景：

```swift
// 场景1：判断是否为新用户
let appTransaction = try await AppTransaction.shared
if case .verified(let transaction) = appTransaction {
    let daysSincePurchase = Calendar.current.dateComponents([.day], 
        from: transaction.originalPurchaseDate, 
        to: Date()).day ?? 0
    if daysSincePurchase < 7 {
        // 新用户，显示引导
    }
}

// 场景2：防欺诈
// 在服务器端验证应用交易信息
```

**结论**：对于大多数应用内购买场景，AppTransaction 不是必需的，主要用于高级场景。

---

## 3. 订阅续订信息（RenewalInfo）详解

### RenewalInfo 包含什么？

```swift
struct RenewalInfo {
    let willAutoRenew: Bool          // 是否会自动续订
    let expirationDate: Date?        // 过期日期
    let renewalDate: Date?           // 续订日期
    // ... 其他信息
}
```

### 机制说明：

1. **willAutoRenew**：
   - `true`：订阅会在过期时自动续订
   - `false`：用户已取消，订阅会在过期后停止

2. **expirationDate**：
   - 当前订阅周期的过期时间
   - 如果 `willAutoRenew = false`，这是最后的使用期限

3. **renewalDate**：
   - 下次续订的日期
   - 如果 `willAutoRenew = false`，可能为 `nil`

### 必要性：

✅ **非常重要**：
- 判断订阅是否会被自动续订
- 判断订阅何时过期
- 判断用户是否取消了订阅（但仍在有效期内）
- 在 UI 上显示"订阅将在 X 天后过期"或"已取消，将在 X 天后失效"

### 使用示例：

```swift
let renewalInfo = await getRenewalInfo(for: "subscription.monthly")
if let info = renewalInfo {
    if info.willAutoRenew {
        print("订阅将自动续订")
    } else {
        print("订阅已取消，将在 \(info.expirationDate) 过期")
    }
}
```

---

## 4. 订阅组（Subscription Group）使用场景

### 什么是订阅组？

订阅组是一组相关的订阅产品，用户在同一组内只能拥有一个活跃订阅。

### 使用场景：

#### 场景1：不同时长的订阅（月付/年付）
```
订阅组 "Premium":
  - premium.monthly (¥9.99/月)
  - premium.yearly (¥99.99/年)

用户购买 monthly 后，再购买 yearly 会：
- 自动取消 monthly
- 激活 yearly
- 可能获得按比例退款
```

#### 场景2：不同等级的订阅
```
订阅组 "VIP":
  - vip.basic (¥19.99/月)
  - vip.pro (¥39.99/月)
  - vip.premium (¥59.99/月)

用户从 basic 升级到 pro：
- 自动取消 basic
- 激活 pro
- 可能获得按比例退款
```

#### 场景3：不同地区的订阅
```
订阅组 "News":
  - news.us (美国新闻)
  - news.eu (欧洲新闻)
  - news.asia (亚洲新闻)

用户只能订阅一个地区的新闻
```

### 订阅组管理的作用：

1. **获取组内所有订阅**：显示所有可选方案
2. **显示组管理界面**：只管理该组的订阅
3. **处理升级/降级**：自动处理组内订阅切换

---

## 5. 支付方式绑定（PaymentMethodBinding）必要性

### 作用：

允许用户绑定第三方支付方式（如支付宝、微信支付）到 App Store 账户。

### 使用场景：

1. **中国市场**：用户可能没有信用卡，需要绑定支付宝/微信
2. **特定地区**：某些地区支持本地支付方式
3. **提高转化率**：降低支付门槛

### 必要性评估：

- **中国市场**：✅ 非常必要
- **其他市场**：⚠️ 可选，取决于目标用户

---

## 6. 产品推广（Product Promotion）必要性

### 作用：

在 App Store 中控制产品的显示顺序和可见性。

### 使用场景：

1. **推广新产品**：将新产品放在前面
2. **隐藏旧产品**：隐藏不再销售的产品
3. **A/B 测试**：测试不同产品顺序的转化率

### 必要性评估：

- **有多个产品**：✅ 有用
- **产品较少**：⚠️ 可选
- **需要精细控制**：✅ 必要

---

---

## 7. 已实现的改进

### ✅ 1. 实现 getSubscriptionInfo 方法
- 使用 `ValidSubscriptionInfo.from(_:)` 获取完整的订阅信息
- 包含订阅状态、续订信息、过期日期等

### ✅ 2. 优化 loadPurchasedTransactions 性能
- 使用 `TaskGroup` 并行获取所有产品的最新交易
- 大幅提升性能，特别是产品数量较多时

### ✅ 3. 添加优惠代码兑换功能
- 支持 iOS 16.0+ 的优惠代码兑换界面
- 兑换后的交易会通过 `Transaction.updates` 自动处理

### ✅ 4. 添加订阅续订信息获取
- `getRenewalInfo(for:)` 方法
- 可以获取 `willAutoRenew`、`expirationDate`、`renewalDate` 等信息

### ✅ 5. 添加家庭共享检测
- `isFamilyShared(productId:)` 方法
- 可以检测产品是否通过家庭共享获得

---

## 总结

### Transaction.updates 的正确理解

**关键点**：
- ✅ `Transaction.updates` 会监听**新交易**（购买、续订、退款、撤销）
- ❌ `Transaction.updates` **不会**监听订阅状态变化（过期、取消、宽限期）

**订阅状态监听**：
- 需要定期检查 `Product.SubscriptionInfo.status`
- 或者在关键时机检查（应用启动、进入前台等）

### 功能完整性

现在 StoreKitManager 已经支持：
- ✅ 基础购买功能
- ✅ 订阅管理
- ✅ 交易历史查询
- ✅ 恢复购买
- ✅ 优惠代码兑换
- ✅ 订阅续订信息获取
- ✅ 家庭共享检测
- ✅ 性能优化（并行处理）

### 建议的使用模式

```swift
// 1. 应用启动时
await StoreKitManager.shared.refreshPurchases()

// 2. 应用进入前台时
await StoreKitManager.shared.refreshPurchases()

// 3. 用户打开订阅页面时
if let info = await StoreKitManager.shared.getSubscriptionInfo(for: "subscription.monthly") {
    // 显示订阅信息
    if let renewalInfo = await StoreKitManager.shared.getRenewalInfo(for: "subscription.monthly") {
        if renewalInfo.willAutoRenew {
            print("订阅将自动续订")
        } else {
            print("订阅已取消，将在 \(renewalInfo.expirationDate) 过期")
        }
    }
}
```

---

**所有改进已完成！** 🎉

